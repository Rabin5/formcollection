{% load static %}
{% load crispy_forms_tags %}

<div class="table-responsive">
    <div class="text-right text-danger"><strong>रु हजारमा</strong></div>
    <table class="table table-01 table-bordered mt-3">
        {{ formset.management_form|crispy }}
        <thead>
            <tr>
            {% for field in formset.forms.0.visible_fields %}
                {% if field.name == 'is_yes' %}
                    <th>छ?</th>
                {% else %}
                    <th>{{ field.label }}</th>
                {% endif %}
            {% endfor %}
                <th class="text-right">कार्य{{form.id}}</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset.forms %} 
                <tr class="{% cycle 'row1' 'row2' %} formset_row-{{ formset.prefix }}">
                    {% for field in form.visible_fields %}
                    <td>
                        {# Include the hidden fields in the form #}
                        {% if forloop.first %}
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        {% endif %}

                        {% if field.name == 'description' %}
                            {% comment %} {{form.instance.pk}} {% endcomment %}
                            <input type="hidden" name="{{form.description.html_name}}" value="{{field.value}}" id="id_{{form.description.html_name}}">
                            {{form.instance.description}}
                        
                        {% comment %} {% elif field.name == 'is_yes' %}
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="customCheck1" name="{{form.is_yes.html_name}}">
                                <label class="custom-control-label" for="customCheck1"></label>
                            </div>
                        </td>
                        <td class="table-checkbox">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="customCheck2" name="{{form.is_yes.html_name}}">
                                <label class="custom-control-label" for="customCheck2"></label>
                            </div> {% endcomment %}

                        {%else%}
                            {{ field|as_crispy_field }}
                        {% endif %}
                        
                    </td>
                    {% endfor %}
                    <td class="action">
                        <a href="">
                            <i class="ic-delete"></i>
                        </a>
                    </td>
                </tr>
            {% endfor %}

        
        </tbody>
    </table>
</div>
<br>
{% if not formset.forms.0.fields.is_yes %}
    <a href="" class="add-more mt-3" id="add_more" onclick="return false;">
        <i class="ic-add"></i>
        Add More
    </a>
{% endif %}
<script>
    {% if formset.forms.0.fields.is_yes %}
        $("tbody tr:last").remove();
    {% endif %}
    var testElement, testType, testTotal=0, select2FieldName=[];
    function cloneMore(selector, type) {
        $(selector).find(".select_class").select2("destroy");
        var newElement = $(selector).clone(true);
        var split_id;

        var total = $('#id_' + type + '-TOTAL_FORMS').val();
        testElement = newElement;
        testType = type;
        testTotal = total;

        newElement.find(':input').each(function () {
            var name = $(this).attr('name').replace('-' + (total - 1) + '-', '-' + total + '-');
            var id = 'id_' + name;
            var split_names = id.split("-")
            if (select2FieldName.includes(split_names[split_names.length - 1])) {
                split_id = split_names[split_names.length - 1];
            }

            $(this).attr({ 'name': name, 'id': id }).val('').removeAttr('checked');
        });
        newElement.find('label').each(function () {
            var newFor = $(this).attr('for').replace('-' + (total - 1) + '-', '-' + total + '-');
            $(this).attr('for', newFor);
        });

        total++;
        $('#id_' + type + '-TOTAL_FORMS').val(total);
        $(selector).after(newElement);

        $($(".select_class")).select2({
            tags: true
        });
    }

    $('#add_more').click(function () {
        select2FieldName = ["laboratory", "office_bearer"];
        cloneMore('tbody tr:last', 'lines');
    });

    {% comment %} $("input:checkbox").on('click', function() {
        // in the handler, 'this' refers to the box clicked on
        var $box = $(this);
        if ($box.is(":checked")) {
            // the name of the box is retrieved using the .attr() method
            // as it is assumed and expected to be immutable
            var group = "input:checkbox[name='" + $box.attr("name") + "']";
            // the checked state of the group/box on the other hand will change
            // and the current value is retrieved using .prop() method
            $(group).prop("checked", false);
            $box.prop("checked", true);
            console.log(group)
        } else {
            $box.prop("checked", false);
        }
    }); {% endcomment %}

    

    {% comment %} function get_select_value(selectId){
        $(selectId).on('change', function() {
            alert( this.value );
        }); 
    }{% endcomment %}
</script>
