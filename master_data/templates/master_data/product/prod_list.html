{% extends 'core/base.html' %}

{% load crispy_forms_tags %}

{% block title %}
  Product - Nepal Audit Management System
{% endblock title %}

{% block page_title %}
Products
{% endblock page_title %}

{% block page_actions %}
  <a class="btn btn-success btn-with-icon" data-remote="{% url 'md-prod:create' %}"
    href="{% url 'md-prod:create' %}" data-toggle="modal" data-target="#modalProdCreate">
    <i class="ic-add"></i>
    Product थप्नुहोस्
  </a>
{% endblock page_actions %}

{% block content %}
<table class="table table-striped table-borderless">
  <thead>
    <tr>
      <th>#.</th>
      <th>Product Name</th>
      <th>Product Type</th>
      <th>Measurement</th>
      <th class="text-right">कार्य</th>
    </tr>
  </thead>
  <tbody>
    {% for prod in prods %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ prod.name }}</td>
        <td>{{ prod.type }}</td>
        <td>{% if prod.uom %}{{prod.uom}}{% else %} - {% endif %}</td>
        <td class="action">
          <a data-remote="{% url 'md-prod:update' prod.pk %}"
            href="{% url 'md-prod:update' prod.pk %}" data-toggle="modal" data-target="#modalProdUpdate">
            <i class="ic-edit mr-2"></i>
          </a>
          <a href="">
            <i class="ic-delete"></i>
          </a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock content %}

{% block modal %}
<div class="modal fade" id="modalProdCreate" tabindex="-1" role="dialog" aria-labelledby="modalProdCreate" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
    </div>
  </div>
</div>

<div class="modal fade" id="modalProdUpdate" tabindex="-1" role="dialog" aria-labelledby="modalProdUpdate" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
    </div>
  </div>
</div>
{% endblock modal %}

{% block extrascripts %}
<script>
  $(document).ready(function () {
    $('#modalProdCreate').on('shown.bs.modal', function (e) {
      var button = $(e.relatedTarget);
      var modal = $(this);
      modal.find('.modal-content').load(button.data("remote"));
    });

    $('#modalProdUpdate').on('shown.bs.modal', function (e) {
      var button = $(e.relatedTarget);
      var modal = $(this);
      modal.find('.modal-content').load(button.data("remote"));
    });
  });

    function saveData(form){
        // var form = $(this);
        // console.log(form, form[0])
        var formdata = new FormData(form[0])
        fetch(form.attr('action'), {
            method: form.attr("method"),
            body: formdata
        })
        .then(function(response){
            window.location.reload();
        })
        .catch(function(err){
            console.log(err);    
        });
        return false;
    }

  $( "#modalProdCreate").on('submit', 'form', function(e) {
    var $prod_modal = $(this);
    e.preventDefault();
    saveData($(this)) 
  });

  $( "#modalProdUpdate").on('submit', 'form', function(e) {
    var $prod_modal = $(this);
    console.log($prod_modal)
    e.preventDefault();
    saveData($(this)) 
  });
</script>
{% endblock extrascripts %}